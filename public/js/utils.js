// ============================================
// Utility Functions - PDF Generation & More
// ============================================

/**
 * Download the current script as a PDF
 */
function downloadScriptPDF() {
    if (!AppState.currentScript) {
        showError('No script to download');
        return;
    }

    const { script, topic, videoType, wordCount, charCount } = AppState.currentScript;
    const timestamp = new Date().toLocaleString();

    // Create PDF using jsPDF
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4',
    });

    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 15;
    const maxWidth = pageWidth - (2 * margin);
    let yPosition = margin;

    // Set fonts and colors
    doc.setFont('Helvetica', 'bold');
    doc.setFontSize(18);
    doc.setTextColor(102, 126, 234); // Purple color

    // Title
    doc.text('ðŸŽ¬ TechFela YouTube Script', margin, yPosition);
    yPosition += 10;

    // Metadata box
    doc.setFont('Helvetica', 'normal');
    doc.setFontSize(10);
    doc.setTextColor(60, 60, 60);

    // Topic
    doc.setFont('Helvetica', 'bold');
    doc.text('Topic:', margin, yPosition);
    doc.setFont('Helvetica', 'normal');
    doc.text(truncateText(topic, 60), margin + 15, yPosition);
    yPosition += 6;

    // Video Type
    doc.setFont('Helvetica', 'bold');
    doc.text('Format:', margin, yPosition);
    doc.setFont('Helvetica', 'normal');
    doc.text(videoType === 'short' ? 'Short (60-90 seconds)' : 'Long (3-6 minutes)', margin + 15, yPosition);
    yPosition += 6;

    // Generated Date
    doc.setFont('Helvetica', 'bold');
    doc.text('Generated:', margin, yPosition);
    doc.setFont('Helvetica', 'normal');
    doc.text(timestamp, margin + 15, yPosition);
    yPosition += 10;

    // Statistics
    doc.setFont('Helvetica', 'bold');
    doc.setFontSize(9);
    doc.text(`Words: ${wordCount} | Characters: ${charCount}`, margin, yPosition);
    yPosition += 8;

    // Divider line
    doc.setDrawColor(102, 126, 234);
    doc.line(margin, yPosition, pageWidth - margin, yPosition);
    yPosition += 8;

    // Main script content
    doc.setFont('Courier', 'normal');
    doc.setFontSize(11);
    doc.setTextColor(0, 0, 0);

    // Split script into lines that fit the page width
    const scriptLines = doc.splitTextToSize(script, maxWidth);
    
    // Add script content with pagination
    for (let i = 0; i < scriptLines.length; i++) {
        const line = scriptLines[i];

        // Check if we need a new page
        if (yPosition + 6 > pageHeight - margin) {
            doc.addPage();
            yPosition = margin;
            
            // Add page footer with page number
            doc.setFont('Helvetica', 'normal');
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text(`Page ${doc.internal.pages.length - 1}`, pageWidth / 2, pageHeight - 5, { align: 'center' });
        }

        doc.text(line, margin, yPosition);
        yPosition += 6;
    }

    // Footer with source
    doc.setFont('Helvetica', 'italic');
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    doc.text('Generated by TechFela YouTube Script Generator', pageWidth / 2, pageHeight - 10, { align: 'center' });

    // Generate filename
    const filename = `TechFela_Script_${topic.replace(/\s+/g, '_').substring(0, 30)}_${videoType}_${Date.now()}.pdf`;

    // Save the PDF
    doc.save(filename);

    // Show success notification
    const downloadBtn = document.getElementById('downloadPdfBtn');
    const originalText = downloadBtn.innerHTML;
    downloadBtn.innerHTML = '<i class="bi bi-check-lg"></i> Downloaded!';
    setTimeout(() => {
        downloadBtn.innerHTML = originalText;
    }, 2000);
}

/**
 * Export script as Text file
 */
function downloadScriptAsText() {
    if (!AppState.currentScript) {
        showError('No script to download');
        return;
    }

    const { script, topic, videoType } = AppState.currentScript;
    const timestamp = new Date().toLocaleString();

    // Create text content
    const textContent = `
TechFela YouTube Script
=======================

Topic: ${topic}
Format: ${videoType === 'short' ? 'Short (60-90 seconds)' : 'Long (3-6 minutes)'}
Generated: ${timestamp}

-------------------
SCRIPT CONTENT
-------------------

${script}

-------------------
Generated by TechFela YouTube Script Generator
https://techfela-scripts.pages.dev
`;

    // Create blob and download
    const blob = new Blob([textContent], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `TechFela_Script_${topic.replace(/\s+/g, '_')}_${Date.now()}.txt`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
}

/**
 * Export script as Markdown
 */
function downloadScriptAsMarkdown() {
    if (!AppState.currentScript) {
        showError('No script to download');
        return;
    }

    const { script, topic, videoType } = AppState.currentScript;
    const timestamp = new Date().toLocaleString();

    // Create markdown content
    const markdownContent = `# ðŸŽ¬ ${topic} - TechFela Script

**Format:** ${videoType === 'short' ? 'Short (60-90 seconds)' : 'Long (3-6 minutes)'}  
**Generated:** ${timestamp}

---

## Script

${script}

---

*Generated by [TechFela YouTube Script Generator](https://techfela-scripts.pages.dev)*
`;

    // Create blob and download
    const blob = new Blob([markdownContent], { type: 'text/markdown' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `TechFela_Script_${topic.replace(/\s+/g, '_')}_${Date.now()}.md`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
}

/**
 * Share script via URL (encode to query parameter)
 */
function shareScript() {
    if (!AppState.currentScript) {
        showError('No script to share');
        return;
    }

    const { script, topic, videoType } = AppState.currentScript;
    
    // Create share data
    const shareData = {
        title: `TechFela Script: ${topic}`,
        text: `Check out this ${videoType} YouTube script for "${topic}" generated by TechFela Script Generator!`,
        url: window.location.href
    };

    // Use Web Share API if available
    if (navigator.share) {
        navigator.share(shareData).catch(err => console.log('Share cancelled'));
    } else {
        // Fallback: copy to clipboard
        const shareText = `Check out this ${videoType} YouTube script for "${topic}"\n${window.location.href}`;
        navigator.clipboard.writeText(shareText).then(() => {
            alert('Share link copied to clipboard!');
        });
    }
}

/**
 * Validate Gemini API Key format
 */
function validateApiKey(key) {
    // Gemini API keys typically start with 'AIza' or similar patterns
    return key && key.length > 10 && /^[A-Za-z0-9_-]+$/.test(key);
}

/**
 * Format timestamp for display
 */
function formatTimestamp(date) {
    return new Date(date).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

/**
 * Calculate reading time in minutes
 */
function calculateReadingTime(text) {
    const wordsPerMinute = 200;
    const wordCount = text.split(/\s+/).length;
    const minutes = Math.ceil(wordCount / wordsPerMinute);
    return minutes;
}

/**
 * Generate a summary of the script
 */
function generateScriptSummary(script, maxLength = 150) {
    const sentences = script.split(/[.!?]+/).filter(s => s.trim().length > 0);
    let summary = sentences[0]?.trim() || '';
    
    while (summary.length < maxLength && sentences.length > 1) {
        sentences.shift();
        summary += '. ' + sentences[0]?.trim();
    }
    
    return truncateText(summary, maxLength) + (summary.length >= maxLength ? '...' : '');
}

/**
 * Highlight keywords in script
 */
function highlightKeywords(script, keywords) {
    let highlightedScript = script;
    keyword = keywords.split(',').map(k => k.trim());
    
    keywords.forEach(keyword => {
        const regex = new RegExp(`\\b${keyword}\\b`, 'gi');
        highlightedScript = highlightedScript.replace(regex, `<mark>${keyword}</mark>`);
    });
    
    return highlightedScript;
}

/**
 * Print script
 */
function printScript() {
    if (!AppState.currentScript) {
        showError('No script to print');
        return;
    }

    const { script, topic, videoType } = AppState.currentScript;
    const timestamp = new Date().toLocaleString();

    const printWindow = window.open('', '', 'height=800,width=1000');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Print - ${topic}</title>
            <style>
                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; line-height: 1.6; }
                h1 { color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
                .metadata { background: #f5f5f5; padding: 10px; border-radius: 5px; margin: 15px 0; }
                .script { white-space: pre-wrap; font-family: 'Courier New', monospace; margin: 20px 0; }
                .footer { text-align: center; color: #999; margin-top: 40px; border-top: 1px solid #ddd; padding-top: 20px; }
            </style>
        </head>
        <body>
            <h1>ðŸŽ¬ TechFela YouTube Script</h1>
            <div class="metadata">
                <p><strong>Topic:</strong> ${topic}</p>
                <p><strong>Format:</strong> ${videoType === 'short' ? 'Short (60-90 seconds)' : 'Long (3-6 minutes)'}</p>
                <p><strong>Generated:</strong> ${timestamp}</p>
            </div>
            <div class="script">${script}</div>
            <div class="footer">
                <p>Generated by TechFela YouTube Script Generator</p>
            </div>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

/**
 * Email script (opens mailto)
 */
function emailScript() {
    if (!AppState.currentScript) {
        showError('No script to email');
        return;
    }

    const { script, topic, videoType } = AppState.currentScript;
    const subject = encodeURIComponent(`TechFela Script: ${topic} (${videoType})`);
    const body = encodeURIComponent(`Here's the YouTube script for "${topic}"\n\n${script}`);
    
    window.location.href = `mailto:?subject=${subject}&body=${body}`;
}

/**
 * Count specific occurrences in script
 */
function analyzeScript(script) {
    const analysis = {
        totalWords: script.split(/\s+/).length,
        totalCharacters: script.length,
        sentences: script.split(/[.!?]+/).length - 1,
        paragraphs: script.split('\n').length,
        averageWordLength: 0,
        averageSentenceLength: 0,
        readingTimeMinutes: calculateReadingTime(script),
        uniqueWords: new Set(script.toLowerCase().match(/\b\w+\b/g)).size,
    };

    // Calculate averages
    if (analysis.totalWords > 0) {
        analysis.averageWordLength = (script.replace(/\s+/g, '').length / analysis.totalWords).toFixed(2);
    }
    if (analysis.sentences > 0) {
        analysis.averageSentenceLength = (analysis.totalWords / analysis.sentences).toFixed(2);
    }

    return analysis;
}

/**
 * Generate SEO keywords from script
 */
function extractKeywords(script, count = 10) {
    // Remove common words
    const commonWords = new Set(['the', 'a', 'an', 'and', 'or', 'but', 'is', 'to', 'of', 'in', 'for', 'on', 'with', 'as', 'be', 'by', 'that', 'this', 'it']);
    
    const words = script.toLowerCase().match(/\b\w+\b/g);
    const frequency = {};
    
    words.forEach(word => {
        if (word.length > 3 && !commonWords.has(word)) {
            frequency[word] = (frequency[word] || 0) + 1;
        }
    });

    // Sort by frequency and return top keywords
    return Object.entries(frequency)
        .sort((a, b) => b[1] - a[1])
        .slice(0, count)
        .map(([word]) => word);
}

/**
 * Create a table of contents for long scripts
 */
function generateTableOfContents(script) {
    const lines = script.split('\n');
    const toc = [];
    let lineNumber = 0;

    lines.forEach((line, index) => {
        lineNumber += line.split(/\s+/).length;
        
        // Look for section markers (lines that start with numbers or contain section keywords)
        if (/^\(\d+.*seconds?\)/.test(line) || /^(introduction|background|benefits|disadvantages|conclusion|steps|outro)/i.test(line)) {
            toc.push({
                title: line.substring(0, 50),
                lineNumber: index,
                wordPosition: lineNumber
            });
        }
    });

    return toc;
}

// Export functions to global scope
window.downloadScriptAsText = downloadScriptAsText;
window.downloadScriptAsMarkdown = downloadScriptAsMarkdown;
window.shareScript = shareScript;
window.printScript = printScript;
window.emailScript = emailScript;
window.validateApiKey = validateApiKey;
window.analyzeScript = analyzeScript;
window.extractKeywords = extractKeywords;
window.generateScriptSummary = generateScriptSummary;
window.generateTableOfContents = generateTableOfContents;
